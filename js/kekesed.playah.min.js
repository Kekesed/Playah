/*
  Playan HTML 5 Audio Player
  Requires Metro UI v3, jQuery.

   Created by Mealkuwat a.k.a Kekesed
   https://kekesed.id

   @author: Mealkuwat // Kekesed
   @copyright: Copyright (c) 2016 Kekesed. Some rights reserved.
   @link: https://kekesed.id/


  Saya orang Indonesia.
  Jadilah warganegara yang membanggakan.
*/
$.widget("Kekesed.Playah",{options:{autoplay:false,random:false,loop:true,android_mode:true,sc_id:undefined,playlist:[],theme:{base:"white",accent:"darkBlue"},header:{height:"150px",options:{"data-role":"fitImage","data-type":"sd"}},callback:{onNext:function(SongData){},onPrev:function(SongData){},onError:function(Err,SongData){},onLoad:function(){}}},statik:{kontrol:{skeleton:{kepala:$("<div/>"),progress:$("<div/>",{"class":"progress no-margin","data-value":0,"data-role":"progress"}),badan:$("<div/>",{"class":"no-margin padding20 align-center"})},badan:{judul:$("<div/>",{"class":"text-bold no-margin",text:"...."}),subjudul:$("<p/>",{"class":"text-small"}),artis:$("<b/>",{text:"Hayashi"}),album:$("<span/>",{text:"Playah"}),kPlay:$("<button/>",{"class":"button fg-white bg-blue"}),kBckw:$("<button/>",{"class":"button mini-button"}),kFrwd:$("<button/>",{"class":"button mini-button"}),iPlay:$("<span/>",{"class":"mif-play"}),iPaus:$("<span/>",{"class":"mif-pause"}),iBack:$("<span/>",{"class":"mif-backward"}),iForw:$("<span/>",{"class":"mif-forward"})}},cache:{player:undefined,isplaying:false},siklus:{Playmate:[],curr_num:-1,curr_audio:undefined}},_create:function(){var bdn=this.statik.kontrol.badan;var bdn_=this.statik.kontrol.skeleton.badan;this.statik.kontrol.skeleton.kepala.addClass("align-center bg-"+this.options.theme.accent);this.statik.kontrol.skeleton.kepala.css({height:this.options.header.height,overflow:"hidden"});this.statik.kontrol.badan.artis.addClass("fg-"+this.options.theme.accent);this.statik.kontrol.skeleton.progress.data("data-color",this.options.theme.accent);this.statik.kontrol.skeleton.badan.addClass("bg-grayLighter");bdn.kPlay.append(bdn.iPlay);bdn.kBckw.append(bdn.iBack);bdn.kFrwd.append(bdn.iForw);bdn.subjudul.append(bdn.artis).append("&nbsp;&nbsp;").append(bdn.album);bdn.album.click(function(e){e.preventDefault();if($(this).data("url"))window.open($(this).data("url"),"_blank")});bdn_.append(bdn.judul).append(bdn.subjudul).append(bdn.kBckw).append(bdn.kPlay).append(bdn.kFrwd);this.element.append(this.statik.kontrol.skeleton.kepala).append(this.statik.kontrol.skeleton.progress).append(this.statik.kontrol.skeleton.badan);this.sc.data.clid=this.options.sc_id;this.options.callback.onLoad();this.element.trigger("loaded");var opt=this.options;var par=this;this.resolve_playlist().then(function(){par._next(true);if(opt.autoplay)par._emit();else par._emit(true);par.update_kiri_kanan();var sket=par.statik.kontrol.badan;$(sket.kPlay).click(function(){if(!par.statik.cache.isplaying)$(par.statik.cache.player).trigger("play");else $(par.statik.cache.player).trigger("pause")});$(sket.kBckw).click(function(){par._prev()});$(sket.kFrwd).click(function(){par._next()});$(par.statik.kontrol.skeleton.progress).click(function(e){var x=e.pageX-$(this).offset().left;var persen=x/$(this).innerWidth();var letakDurasi=$(par.statik.cache.player).prop("duration")*persen;$(par.statik.cache.player)[0].currentTime=letakDurasi})}).catch(function(err){par._trigger("error",[err]);par.options.callback.onError(err,Object.assign({},par.statik.siklus.curr_audio))})},update_kiri_kanan:function(){var opt=this.options;if(this.statik.siklus.Playmate.length<=0){$(this.statik.kontrol.badan.kBckw).prop("disabled",true);$(this.statik.kontrol.badan.kFrwd).prop("disabled",true);$(this.statik.kontrol.badan.kPlay).prop("disabled",true);return}else if(this.statik.siklus.Playmate.length==1){$(this.statik.kontrol.badan.kBckw).prop("disabled",true);$(this.statik.kontrol.badan.kFrwd).prop("disabled",true);$(this.statik.kontrol.badan.kPlay).prop("disabled",false)}else{$(this.statik.kontrol.badan.kBckw).prop("disabled",false);$(this.statik.kontrol.badan.kFrwd).prop("disabled",false);$(this.statik.kontrol.badan.kPlay).prop("disabled",false)}},resolve_playlist:function(){var par=this;var opt=this.options;return new Promise(function(ok,err){var crrPlaylist=[];var sc=false;var first=true;if(Array.isArray(opt.playlist)){opt.playlist.forEach(function(dat){if(dat.type=="soundcloud"){sc=true;par.sc.trackify(dat).then(function(kembalian){if(kembalian)if(Array.isArray(kembalian)){kembalian.forEach(function(da){crrPlaylist.push(da)})}else crrPlaylist.push(kembalian);if(first)ok();first=false;par.update_kiri_kanan()}).catch(function(errz){err(errz)})}else{crrPlaylist.push(dat)}par.update_kiri_kanan()});if(opt.random)par.statik.siklus.Playmate=par._fliptable(crrPlaylist);else par.statik.siklus.Playmate=crrPlaylist;if(!sc)ok();par.update_kiri_kanan()}else{par.statik.siklus.Playmate=[].concat(opt.playlist);ok()}})},sc:{data:{clid:undefined},trackify:function(data){var par=this;return new Promise(function(ok,errz){if(par.data.clid==undefined||par.data.clid==""){errz({context:"cycle.soundloud-integration",detail:"Client ID are unsetted"});return}par.resolve("resolve",{url:data.path}).then(function(datz){if(datz.uri.search("track")!=-1)var ret={type:"soundcloud",path:datz.stream_url+"?client_id="+par.data.clid,meta:{contribute:datz.permalink_url,artist:datz.user.username,title:datz.title,album:"Soundcloud",image:datz.artwork_url.replace("large","crop")}};if(datz.uri.search("playlist")!=-1){var ret=[];datz.tracks.forEach(function(datx){ret.push({type:"soundcloud",path:datx.stream_url+"?client_id="+par.data.clid,meta:{contribute:datx.permalink_url,artist:datx.user.username,title:datx.title,album:datz.title,image:(datx.artwork_url?datx.artwork_url:datx.user.avatar_url).replace("large","crop")}})})}ok(ret)}).catch(function(err){errz({context:"cycle.soundcloud-integration",detail:"Ajax Error, something happend. See Error.debugData",debugData:err})})})},resolve:function(url,data){var dat=Object.assign({client_id:this.data.clid},data);return new Promise(function(ok,err){$.ajax({url:"https://api.soundcloud.com/"+url,data:dat,method:"get"}).always(function(data){ok(data)}).fail(function(errz){err(errz)})})}},_emit:function(prepare){prepare=prepare||false;this._sodok_audio(this.statik.siklus.curr_audio);this._ganti_judul(this.statik.siklus.curr_audio.meta);if(this.statik.cache.isplaying||!prepare&&this.statik.cache.isplaying)$(this.statik.cache.player).trigger("play");this._integrate_listener()},_ganti_judul:function(data){var knt=this.statik.kontrol.badan;knt.judul.text(data.title);knt.artis.text(data.artist);knt.album.text("");if(data.contribute){knt.album.append($("<span/>",{"class":"mif-soundcloud mif-2x fg-orange"})).append("&nbsp;");knt.album.addClass("sc-contribute").css({cursor:"pointer"});knt.album.data("url",data.contribute)}else{knt.album.removeClass("sc-contribute");knt.album.data("url","").css({cursor:"pointer"})}knt.album.append(data.album);var kp=this.statik.kontrol.skeleton.kepala;if(data.image)$(kp).html("").append($("<img/>",Object.assign({src:data.image},this.options.header.options)));else $(kp).html("")},_sodok_audio:function(data){var curr=this.statik.cache.isplaying;if(!(this.statik.cache.player==undefined))$(this.statik.cache.player).trigger("pause");this.statik.cache.isplaying=curr;this.statik.cache.player=$("<audio/>",{type:"audio/mp3",src:data.path,autoplay:false,control:false});$(this.statik.cache.player).trigger("load")},_integrate_listener:function(){var par=this;var ply=false;$(this.statik.cache.player).on({timeupdate:function(){$(par.statik.kontrol.skeleton.progress).data("progress").set($(this).prop("currentTime")/$(this).prop("duration")*100)},ended:function(){par.element.trigger("ended",[par.statik.siklus.curr_audio]);if(par.statik.siklus.Playmate.length>1){par.statik.cache.isplaying=true;par._next()}},playing:function(){ply=true;par.statik.cache.isplaying=ply;par.statik.kontrol.badan.kPlay.html("").append(par.statik.kontrol.badan.iPaus);par.element.trigger("playing",[par.statik.siklus.curr_audio])},play:function(){ply=true;par.statik.cache.isplaying=ply;par.statik.kontrol.badan.kPlay.html("").append(par.statik.kontrol.badan.iPaus);par.element.trigger("play",[par.statik.siklus.curr_audio])},pause:function(){ply=false;par.statik.cache.isplaying=ply;par.statik.kontrol.badan.kPlay.html("").append(par.statik.kontrol.badan.iPlay);par.element.trigger("pause",[par.statik.siklus.curr_audio])},seeking:function(){ply=false;par.statik.cache.isplaying=ply;par.statik.kontrol.badan.kPlay.html("").append(par.statik.kontrol.badan.iPlay);par.element.trigger("seeking",[par.statik.siklus.curr_audio])},waiting:function(){ply=false;par.statik.cache.isplaying=ply;par.statik.kontrol.badan.kPlay.html("").append(par.statik.kontrol.badan.iPlay)},error:function(ev){ply=false;par.statik.cache.isplaying=ply;par.statik.kontrol.badan.kPlay.html("").append(par.statik.kontrol.badan.iPlay);par.element.trigger("error",[{context:"player.html5-integration",description:"Unknown Error on Player",detail:ev},par.statik.siklus.curr_audio])}})},_next:function(cancel_emit){cancel_emit=cancel_emit||false;var cnum=this.statik.siklus.curr_num;if(cnum>=this.statik.siklus.Playmate.length-1&&!this.options.loop){}else{cnum=(cnum+1)%this.statik.siklus.Playmate.length;this.statik.siklus.curr_audio=this.statik.siklus.Playmate[cnum];this.statik.siklus.curr_num=cnum;this.element.trigger("next");if(!cancel_emit)this._emit()}},_prev:function(){if(this.options.android_mode){if(this.statik.cache.player.prop("currentTime")>5){this.statik.cache.player.prop("currentTime",0);return}}var cnum=this.statik.siklus.curr_num;if(cnum<=0&&this.options.loop)cnum=this.statik.siklus.Playmate.length-1;else cnum--;this.statik.siklus.curr_audio=this.statik.siklus.Playmate[cnum];this.statik.siklus.curr_num=cnum;console.info("Prev! Current number: "+cnum);console.log(this.statik.siklus.curr_audio);this.element.trigger("prev",[par.statik.siklus.curr_audio]);this._emit()},_fliptable:function(array){for(var i=array.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var temp=array[i];array[i]=array[j];array[j]=temp}return array}});$.fn.extend({ksd_info:{Playah:"2.0"}});